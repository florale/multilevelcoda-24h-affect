---
title: "Daily Affect Sleep-wake Composition"
author: "Flora Le (flora.le@monash.edu)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(extraoperators)
library(compositions)
library(zCompositions)
library(multilevelcoda)
library(brms)
library(cmdstanr)
library(insight)
library(MASS)
library(bayestestR)

library(doFuture)
library(foreach)
library(parallel)
library(doRNG)
library(future)
library(multilevelTools)
library(JWileymisc)
library(bayesplot)
```


## Data scoring

```{r}
shs <- as.data.table(readRDS("/Volumes/shared/Behavioral-med-lab/StressHealthStudy/SHS Research Interns/Data/shs_daily_ggir.RDS"))
destress <- readRDS("/Volumes/shared/Behavioral-med-lab/DESTRESSStudy/Data/destress_daily_ggir.RDS")
aces <- readRDS("/Volumes/shared/Behavioral-med-lab/ACESStudy/Data/aces_daily_ggir.RDS")

parts5 <- c("Sleepg", "WAKEg", "MVPAg", "LPAg", "SBg")

d <- rbind(shs[, .(ID, UID = paste0("S", ID), SurveyDay, 
                   PosAffHA, PosAffLA, NegAffHA, NegAffLA,
                   PosAffHANextDay, PosAffLANextDay, NegAffHANextDay, NegAffLANextDay,
                   Sleepg, WAKEg, MVPAg, LPAg, SBg)],
           destress[, .(ID, UID = paste0("D", ID), SurveyDay, 
                        PosAffHA, PosAffLA, NegAffHA, NegAffLA,
                        PosAffHANextDay, PosAffLANextDay, NegAffHANextDay, NegAffLANextDay,
                        Sleepg, WAKEg, MVPAg, LPAg, SBg)],
           aces[, .(ID, UID = paste0("A", ID), SurveyDay,
                    PosAffHA, PosAffLA, NegAffHA, NegAffLA,
                    PosAffHANextDay, PosAffLANextDay, NegAffHANextDay, NegAffLANextDay,
                    Sleepg, WAKEg, MVPAg, LPAg, SBg)])
d <- d[complete.cases(d[, .(Sleepg, WAKEg, MVPAg, LPAg, SBg)])]

composition_imp <- lrEM(d[, parts5, with = FALSE], label = 0,dl = rep(1,5), ini.cov = "multRepl")
d <- cbind(d[, -parts5, with = FALSE], composition_imp)

# make composition
sbp <- matrix(c(
  1, 1, -1,-1, -1,
  1, -1, 0, 0, 0,
  0, 0, 1, -1, -1,
  0, 0, 0, 1, -1), ncol = 5, byrow = TRUE)

mean(d$Sleepg)
mean(d$WAKEg)
mean(d$MVPAg)
mean(d$LPAg)
mean(d$SBg)

cilr5 <- compilr(d, sbp = sbp,
                 parts = parts5, idvar = "UID")
```

## HAPA

```{r}

mhapa <- brmcoda(cilr5,
              PosAffHANextDay ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + PosAffHA + (1 | UID), 
             cores = 4,
             chains = 4,
             iter = 3000,
             warmup = 500,
             seed = 123,
             backend = "cmdstanr"
)

mhapa <- brmcoda(cilr5,
              PosAffHA ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + (1 | UID), 
             cores = 4,
             chains = 4,
             iter = 3000,
             warmup = 500,
             seed = 123,
             backend = "cmdstanr"
)

summary(mhapa$Model)

mhapa_sub <- substitution(
  mhapa,
  delta = c(1:30),
  level = c("between", "within"),
  type = "conditional")

plotsub(mhapa_sub$BetweenSub$Sleepg, "Sleep", "HAPA")
plotsub(mhapa_sub$BetweenSub$WAKEg, "WAKEg", "HAPA")
plotsub(mhapa_sub$BetweenSub$MVPAg, "MVPAg", "HAPA")
plotsub(mhapa_sub$BetweenSub$LPAg, "LPAg", "HAPA")
plotsub(mhapa_sub$BetweenSub$SBg, "SBg", "HAPA")

plotsub(mhapa_sub$WithinSub$Sleepg, "Sleep", "HAPA")
plotsub(mhapa_sub$WithinSub$WAKEg, "WAKEg", "HAPA")
plotsub(mhapa_sub$WithinSub$MVPAg, "MVPAg", "HAPA")
plotsub(mhapa_sub$WithinSub$LPAg, "LPAg", "HAPA")
plotsub(mhapa_sub$WithinSub$SBg, "SBg", "HAPA")

```




## LAPA

```{r}
mlapa <- brmcoda(cilr5,
              PosAffLANextDay ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + PosAffLA + (1 | UID), 
             cores = 4,
             chains = 4,
             iter = 3000,
             warmup = 500,
             seed = 123,
             backend = "cmdstanr"
)
summary(mlapa$Model)

mlapa_sub <- substitution(
  mlapa,
  delta = c(1:30),
  level = c("between", "within"),
  type = "conditional")

plotsub(mlapa_sub$BetweenSub$Sleepg, "Sleep", "LAPA")
plotsub(mlapa_sub$BetweenSub$WAKEg, "WAKEg", "LAPA")
plotsub(mlapa_sub$BetweenSub$MVPAg, "MVPAg", "LAPA")
plotsub(mlapa_sub$BetweenSub$LPAg, "LPAg", "LAPA")
plotsub(mlapa_sub$BetweenSub$SBg, "SBg", "LAPA")

plotsub(mlapa_sub$WithinSub$Sleepg, "Sleep", "LAPA")
plotsub(mlapa_sub$WithinSub$WAKEg, "WAKEg", "LAPA")
plotsub(mlapa_sub$WithinSub$MVPAg, "MVPAg", "LAPA")
plotsub(mlapa_sub$WithinSub$LPAg, "LPAg", "LAPA")
plotsub(mlapa_sub$WithinSub$SBg, "SBg", "LAPA")

```

## HANA

```{r}
mhana <- brmcoda(cilr5,
              NegAffHANextDay ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + NegAffHA + (1 | UID), 
             cores = 4,
             chains = 4,
             iter = 3000,
             warmup = 500,
             seed = 123,
             backend = "cmdstanr"
)

mhana <- brmcoda(cilr5,
              NegAffHA ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + (1 | UID), 
             cores = 4,
             chains = 4,
             iter = 3000,
             warmup = 500,
             seed = 123,
             backend = "cmdstanr"
)

summary(mhana$Model)

mhana_sub <- substitution(
  mhana,
  delta = c(1:30),
  level = c("between", "within"),
  type = "conditional")

plotsub(mhana_sub$BetweenSub$Sleepg, "Sleep", "HANA")
plotsub(mhana_sub$BetweenSub$WAKEg, "WAKEg", "HANA")
plotsub(mhana_sub$BetweenSub$MVPAg, "MVPAg", "HANA")
plotsub(mhana_sub$BetweenSub$LPAg, "LPAg", "HANA")
plotsub(mhana_sub$BetweenSub$SBg, "SBg", "HANA")

plotsub(mhana_sub$WithinSub$Sleepg, "Sleep", "HANA")
plotsub(mhana_sub$WithinSub$WAKEg, "WAKEg", "HANA")
plotsub(mhana_sub$WithinSub$MVPAg, "MVPAg", "HANA")
plotsub(mhana_sub$WithinSub$LPAg, "LPAg", "HANA")
plotsub(mhana_sub$WithinSub$SBg, "SBg", "HANA")

```

## LANA

```{r}
mlana <- brmcoda(cilr5,
              NegAffLANextDay ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + NegAffLA + (1 | UID), 
             cores = 4,
             chains = 4,
             iter = 3000,
             warmup = 500,
             seed = 123,
             backend = "cmdstanr"
)
summary(mlana$Model)

mlana_sub <- substitution(
  mlana,
  delta = c(1:30),
  level = c("between", "within"),
  type = "conditional")

plotsub(mlana_sub$BetweenSub$Sleepg, "Sleep", "LANA")
plotsub(mlana_sub$BetweenSub$WAKEg, "WAKEg", "LANA")
plotsub(mlana_sub$BetweenSub$MVPAg, "MVPAg", "LANA")
plotsub(mlana_sub$BetweenSub$LPAg, "LPAg", "LANA")
plotsub(mlana_sub$BetweenSub$SBg, "SBg", "LANA")

plotsub(mlana_sub$WithinSub$Sleepg, "Sleep", "LANA")
plotsub(mlana_sub$WithinSub$WAKEg, "WAKEg", "LANA")
plotsub(mlana_sub$WithinSub$MVPAg, "MVPAg", "LANA")
plotsub(mlana_sub$WithinSub$LPAg, "LPAg", "LANA")
plotsub(mlana_sub$WithinSub$SBg, "SBg", "LANA")
```

